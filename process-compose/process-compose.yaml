version: "3"

environment:

processes:
  # movement:
  #   command: |
  #     exit 1
  #   readiness_probe:
  #     exec:
  #       command: echo "true"
  
  build-cli:
    command: |
      cd ..
      yarn install
      yarn build
      cd typescript/cli && hyperlane --help

  deploy-core:
    command: |
      ./scripts/deploy-core.bash
     
  start-eth-chain:
    command: |
      anvil --chain-id 666 --config-out "./anvil.json" --port 4242
    readiness_probe:
      exec:
        command: echo "true"

  build-eth-contracts:
    command: |
      yarn install
      cd ../solidity && forge build
    depends_on:
      start-eth-chain:
        condition: process_healthy
    readiness_probe:
      exec:
        command: echo "true"

  deploy-eth-contracts:
    command: |
      cd ..
      ./scripts/deploy-eth-contracts.bash 
    depends_on:
      start-eth-chain:
        condition: process_healthy
      build-eth-contracts:
        condition: process_healthy
    readiness_probe:
      exec:
        command: echo "true"

  relayer:
    command: |
      cd ..
      ./scripts/run-relayer.bash
    depends_on:
      deploy-eth-contracts:
        condition: process_healthy
    readiness_probe:
      exec:
        command: echo "true"

  validator:
    command: |
      cd ../rust && cargo run -p validator
    readiness_probe:
      exec:
        command: echo "true"
